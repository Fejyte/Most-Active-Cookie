# importing required modules
import argparse
import sys
from datetime import datetime


def get_arguments():
    # create a parser object
    parser = argparse.ArgumentParser(description="Parses for arguments of the Most active cookie")

    # add arguments
    parser.add_argument("filename", help="Store of cookie activity")
    parser.add_argument("-d", help="Date of interest")

    # parse the arguments from standard input
    arguments = vars(parser.parse_args())

    return arguments


def date_time_converter(arg):
    # Convert argument in one format to a date string
    try:
        return str(datetime.strptime(arg, "%Y-%m-%dT%H:%M:%S").date())
    except ValueError:
        print("Please ensure your date time is in the format Year-month-dayThour:minute:secondZ")


def read_cookie_data(cookie_file):
    cookie_data = []
    with open(cookie_file, 'r') as file:
        for cookie in file:
            cookie_data.append(cookie)

    if not cookie_data:
        quit("This file is empty")

    return cookie_data


def get_most_used_cookie(filename, date_of_interest) -> object:
    cookie_usage_count = {}
    file = read_cookie_data(filename)

    for line in file:
        cookie_id, datetime_used = line.split(",", 1)[0], line.split(",", 1)[1]
        if cookie_id == 'cookie': continue

        if date_time_converter(datetime_used[:-7]) == date_of_interest:
            if cookie_id in cookie_usage_count.keys():
                cookie_usage_count[cookie_id] += 1
            else:
                cookie_usage_count[cookie_id] = 1
                
    results = []
    
    for cookie in cookie_usage_count.keys():
        if cookie_usage_count[cookie] == max(cookie_usage_count.values()):
            results.append(cookie)

    if not results:
        quit("No cookies match that date")

    return results


if __name__ == "__main__":
    args = get_arguments()
    for i in get_most_used_cookie(args['filename'], args['d']):
        print(i)
